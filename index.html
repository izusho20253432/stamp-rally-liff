<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>スタンプラリーQR</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>スタンプを加算中...</h2>
  <div id="result"></div>

  <script>
  const liffId = "2008140201-3BvRrDMk";
  const gasUrl = "https://script.google.com/macros/s/AKfycbxY5Rruk-ErtJY_u0Rk3U2WOUlXtdwzdhzZPkYu70tuO9-_Q2Ex8mbVy3Afw1kgCt9GXw/exec";

  async function main() {
    try {
      await liff.init({ liffId });
      console.log("✅ LIFF init 完了");

      if (!liff.isLoggedIn()) {
        console.log("未ログイン → ログインします");
        liff.login();
        return;
      }

      console.log("✅ ログイン済み");

      // ★ここでユーザー情報を取得
      const profile = await liff.getProfile();
      console.log("プロフィール取得:", profile);

      // クエリパラメータから shopId を取得
      const params = new URLSearchParams(window.location.search);
      const shopId = params.get("shopId");
      if (!shopId) {
        document.getElementById("result").innerText = "❌ shopId が見つかりません";
        return;
      }

      // ★GAS 呼び出し
      const url = `${gasUrl}?mode=stamp&shopId=${shopId}`;
      console.log("呼び出しURL:", url);

      const res = await fetch(url);
      const text = await res.text();
      console.log("GAS response:", text);

      document.getElementById("result").innerText = "✅ スタンプ加算完了！";
    } catch (e) {
      console.error("LIFF エラー:", e);
      document.getElementById("result").innerText = "⚠️ エラー: " + e.message;
    }
  }

  main();
</script>

</body>
</html>
