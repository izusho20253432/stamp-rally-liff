<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>スタンプラリーQR</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>スタンプを加算中...</h2>
  <div id="result"></div>

 <script>
  const liffId = "2008140201-3BvRrDMk"; 
  // ★ GAS URLはあなたの最新のURLに置き換えてください
  const gasUrl = "https://script.google.com/macros/s/AKfycbzoYFTXDPYdw5TXCG9YUOD2K57VB9G3ujQZpQjmwwpanbkv5sUcfN1KxE7FpF-2w_MZRw/exec"; 

  async function main() {
    // 1. URLから shopId を取得し、セッションに保存/復元を試みる
    const initialParams = new URLSearchParams(window.location.search);
    let shopId = initialParams.get("shopId");
     
    // shopId がURLに含まれていればセッションに保存
    if (shopId) {
        sessionStorage.setItem('tempShopId', shopId);
        console.log("Debug: Initial shopId stored:", shopId);
    } else {
        // URLになければセッションから復元を試みる (リダイレクト後はこちらが動く)
        shopId = sessionStorage.getItem('tempShopId');
        console.log("Debug: shopId restored from session:", shopId);
    }

    await liff.init({ liffId });

    if (!liff.isLoggedIn()) {
      // ログイン処理。この後リダイレクトで戻ってくる
      liff.login({ scope: ["openid", "profile"] });
      return; // ★ ログイン中はここで処理を中断
    }

    // ログイン済みの場合、セッションに shopId が残っているか再確認
    if (!shopId) {
        // shopIdが復元されていない場合、デフォルト値を使用
        shopId = "1001"; 
    }

    // 最終的な shopId のチェック
    if (!shopId || shopId === "1001") {
        // shopId が取得できていない、またはデフォルト値のままの場合はエラーとして表示
      document.getElementById("result").innerText = "❌ shopId が見つかりません (QRコードに shopId を設定してください)";
        // セッションストレージをクリア
        sessionStorage.removeItem('tempShopId');
      return;
    }
    
    // 処理が成功しそうなのでセッションストレージをクリア
    sessionStorage.removeItem('tempShopId');

    const idToken = liff.getIDToken();
    console.log("idToken:", idToken);

    // GASへのリクエストURLを構築 (mode=stampがここで確実に付与される)
    const url = `${gasUrl}?mode=stamp&idToken=${idToken}&shopId=${shopId}`;
    console.log("Debug: Final GAS Request URL:", url);

    try {
      const res = await fetch(url);
      const data = await res.json();
      console.log("GAS response:", data);

      if (data.status === "ok") {
        document.getElementById("result").innerText = "✅ スタンプ加算完了！";
      } else {
        document.getElementById("result").innerText =
          "⚠️ エラー: " + (data.message || "不明なエラー");
      }
    } catch (e) {
      console.error(e);
      document.getElementById("result").innerText = "⚠️ 通信エラーが発生しました";
    }
  }

  main();
</script>

</body>
</html>
