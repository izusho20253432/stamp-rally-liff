<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼QR</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’åŠ ç®—ä¸­...</h2>
  <div id="result"></div>

 <script>
Â  const liffId = "2008140201-3BvRrDMk";Â 
Â  const gasUrl = "https://script.google.com/macros/s/AKfycbzoYFTXDPYdw5TXCG9YUOD2K57VB9G3ujQZpQjmwwpanbkv5sUcfN1KxE7FpF-2w_MZRw/exec";Â 

Â  async function main() {
Â  Â  // 1. URLã‹ã‚‰ shopId ã‚’å–å¾—ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜/å¾©å…ƒã‚’è©¦ã¿ã‚‹
Â  Â  const initialParams = new URLSearchParams(window.location.search);
Â  Â  let shopId = initialParams.get("shopId");
     
    // shopId ãŒURLã«å«ã¾ã‚Œã¦ã„ã‚Œã°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
    if (shopId) {
        sessionStorage.setItem('tempShopId', shopId);
        console.log("Debug: Initial shopId stored:", shopId);
    } else {
        // URLã«ãªã‘ã‚Œã°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
        shopId = sessionStorage.getItem('tempShopId');
        console.log("Debug: shopId restored from session:", shopId);
    }

Â  Â  await liff.init({ liffId });

Â  Â  if (!liff.isLoggedIn()) {
Â  Â  Â  // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§æˆ»ã£ã¦ãã‚‹éš›ã€shopIdã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
Â  Â  Â  liff.login({ scope: ["openid", "profile"] });
Â  Â  Â  return;
Â  Â  }

    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã« shopId ãŒæ®‹ã£ã¦ã„ã‚‹ã‹å†ç¢ºèª
    if (!shopId) {
        // shopIdãŒå¾©å…ƒã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        shopId = "1001"; 
    }

Â  Â  // æœ€çµ‚çš„ãª shopId ã®ãƒã‚§ãƒƒã‚¯
Â  Â  if (!shopId || shopId === "1001") {
        // shopId ãŒå–å¾—ã§ãã¦ã„ãªã„ã€ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ã¾ã¾ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤º
Â  Â  Â  document.getElementById("result").innerText = "âŒ shopId ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (QRã‚³ãƒ¼ãƒ‰ã« shopId ã‚’è¨­å®šã—ã¦ãã ã•ã„)";
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
        sessionStorage.removeItem('tempShopId');
Â  Â  Â  return;
Â  Â  }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    sessionStorage.removeItem('tempShopId');

Â  Â  const idToken = liff.getIDToken();
Â  Â  console.log("idToken:", idToken);

Â  Â  // GASã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã‚’æ§‹ç¯‰
Â  Â  const url = `${gasUrl}?mode=stamp&idToken=${idToken}&shopId=${shopId}`;
    console.log("Debug: Final GAS Request URL:", url); // ğŸ‘ˆ mode=stamp ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

Â  Â  try {
Â  Â  Â  const res = await fetch(url);
Â  Â  Â  const data = await res.json();
Â  Â  Â  console.log("GAS response:", data);

Â  Â  Â  if (data.status === "ok") {
Â  Â  Â  Â  document.getElementById("result").innerText = "âœ… ã‚¹ã‚¿ãƒ³ãƒ—åŠ ç®—å®Œäº†ï¼";
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById("result").innerText =
Â  Â  Â  Â  Â  "âš ï¸ ã‚¨ãƒ©ãƒ¼: " + (data.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.error(e);
Â  Â  Â  document.getElementById("result").innerText = "âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
Â  Â  }
Â  }

Â  main();
</script>

</body>
</html>

