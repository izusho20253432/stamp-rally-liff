<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>スタンプラリーQR</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>スタンプを加算中...</h2>
  <div id="result"></div>

  <script>
    const LIFF_ID = "2008140201-3BvRrDMk"; // ← LIFF ID を入れる
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxY5Rruk-ErtJY_u0Rk3U2WOUlXtdwzdhzZPkYu70tuO9-_Q2Ex8mbVy3Afw1kgCt9GXw/exec ; // ← GAS URL

    async function main() {
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login({ scope: ["openid", "profile"] });
        return;
      }

      const idToken = liff.getIDToken();

      // QRのURLパラメータから shopId を取得
      const params = new URLSearchParams(window.location.search);
      const shopId = params.get("shopId");

      if (!shopId) {
        document.getElementById("result").innerText = "❌ shopId が見つかりません";
        return;
      }

      // GAS にスタンプ加算リクエスト
      const url = `${GAS_URL}?mode=stamp&idToken=${encodeURIComponent(idToken)}&shopId=${shopId}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        console.log("GAS response:", data);

        document.getElementById("result").innerText = `✅ スタンプ加算完了！\n追加数: ${data.added}`;
      } catch (e) {
        console.error(e);
        document.getElementById("result").innerText = "⚠️ エラーが発生しました";
      }
    }

    main();
  </script>
</body>
</html>
